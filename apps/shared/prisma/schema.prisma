// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ENUMS

enum Recommendation {
  STRONG_BUY
  BUY
  HOLD
  SELL
  STRONG_SELL
}

enum CriterionCategory {
  // SENTIMENT 
  // Indicadores psicológicos do mercado (medo, ganância, euforia, pânico). 
  // Usados como sinais contrários: medo extremo tende a indicar compra, 
  // euforia extrema tende a indicar venda. 

  // TECHNICAL 
  // Indicadores baseados em preço e volume históricos. 
  // Avaliam tendência, força do movimento e possíveis reversões 
  // (ex: médias móveis, RSI, preço vs histórico). 

  // MACRO 
  // Indicadores de contexto geral do mercado cripto. 
  // Medem risco sistêmico e alocação de capital 
  // (ex: dominância do Bitcoin, fluxo para altcoins)

  SENTIMENT
  TECHNICAL
  MACRO
}

// MODELS

model Asset {
  id     Int    @id @default(autoincrement())
  symbol String @unique // BTC, ETH, SOL...
  name   String
  extras Json? // qualquer dado extra (ex: CoinGecko ID, CoinMarketCap ID, etc)

  snapshots MarketSnapshot[]
  analyses  Analysis[]

  createdAt DateTime @default(now())
}

model MarketSnapshot {
  id      Int   @id @default(autoincrement())
  assetId Int
  asset   Asset @relation(fields: [assetId], references: [id])

  priceUsd     Decimal  @db.Decimal(18, 8)
  volume24hUsd Decimal  @db.Decimal(24, 2)
  marketCapUsd Decimal? @db.Decimal(24, 2)

  btcDominance Decimal? @db.Decimal(5, 2)
  fearGreed    Int? // 0-100

  source      String // CoinGecko, CoinMarketCap, etc
  cachedUntil DateTime // TTL do cache

  createdAt DateTime   @default(now())
  analyses  Analysis[]

  // @@index([assetId])
  @@index([assetId, createdAt])
}

model AnalysisEngineVersion {
  id          Int     @id @default(autoincrement())
  name        String // ex: "v1-default"
  description String?
  isActive    Boolean @default(true)

  weights  CriterionWeight[]
  analyses Analysis[]

  createdAt DateTime @default(now())
}

model Criterion {
  id          Int               @id @default(autoincrement())
  code        String            @unique // ex: SENTIMENT_FEAR_GREED
  name        String
  description String?
  category    CriterionCategory

  weights CriterionWeight[]
}

model CriterionWeight {
  id              Int @id @default(autoincrement())
  engineVersionId Int
  criterionId     Int

  importanceWeight Decimal @db.Decimal(5, 2) // ex: 0.40
  scoreMin         Int // geralmente 0
  scoreMax         Int // geralmente 10

  engineVersion AnalysisEngineVersion @relation(fields: [engineVersionId], references: [id])
  criterion     Criterion             @relation(fields: [criterionId], references: [id])

  @@unique([engineVersionId, criterionId])
}


model Analysis {
  id      Int   @id @default(autoincrement())
  assetId Int
  asset   Asset @relation(fields: [assetId], references: [id])

  sentimentScore Decimal @db.Decimal(5, 2)
  technicalScore Decimal @db.Decimal(5, 2)
  macroScore     Decimal @db.Decimal(5, 2)
  finalScore     Decimal @db.Decimal(5, 2)

  recommendation Recommendation

  snapshotId Int
  snapshot   MarketSnapshot @relation(fields: [snapshotId], references: [id])

  engineVersionId Int
  engineVersion   AnalysisEngineVersion @relation(fields: [engineVersionId], references: [id])

  createdAt DateTime @default(now())

  // @@index([snapshotId])
  // @@index([engineVersionId])
  @@index([assetId, createdAt])
}

// model ApiRequestLog {
//   id         Int    @id @default(autoincrement())
//   ip         String
//   endpoint   String
//   method     String
//   statusCode Int

//   createdAt DateTime @default(now())

//   @@index([ip, createdAt])
// }